{% extends 'main/base.html' %}
{% block content %}
<h2 class="page-title">Ð”Ð¸Ð°Ð»Ð¾Ð³</h2>

<div class="card" id="chat-box" style="max-height:500px; overflow:auto; display:flex; flex-direction:column; gap:10px;">
  {% for msg in messages_qs %}
    <div class="msg" data-id="{{ msg.id }}" style="display:flex; flex-direction:column; align-items:{% if msg.author == user %}flex-end{% else %}flex-start{% endif %};">
      <div style="font-size:12px; color:#a8a8a8; margin-bottom:4px;">{{ msg.author.username }} Â· {{ msg.created_at|date:"d.m H:i" }}</div>
      <div style="display:inline-block; max-width:78%; background:{% if msg.author == user %}#3f341d{% else %}#23232b{% endif %}; border:1px solid rgba(212,175,55,0.25); padding:10px 12px; border-radius:12px;">
        {% if msg.content %}<div style="white-space:pre-wrap;">{{ msg.content }}</div>{% endif %}
        {% if msg.image %}<div><img src="{{ msg.image.url }}" style="max-width:220px; border-radius:8px; margin-top:6px;"></div>{% endif %}
        {% if msg.attachment %}<div style="margin-top:6px;"><a href="{{ msg.attachment.url }}" target="_blank">ðŸ“Ž Ð’Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ</a></div>{% endif %}
      </div>
    </div>
  {% endfor %}
</div>
<div id="typing-indicator" style="height:18px; font-size:12px; color:#9f9f9f; margin:6px 0 12px;"></div>

<div class="card">
  <form method="post" enctype="multipart/form-data" id="message-form">
    {% csrf_token %}
    {{ form.content }}
    <div style="display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
      <label class="attach-btn" for="id_image">ðŸ“Ž Ð¤Ð¾Ñ‚Ð¾</label>
      <input class="file-attach-input" id="id_image" name="image" type="file" accept="image/*">
      <span class="attach-name" id="image-name">Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½</span>
    </div>
    <div style="display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
      <label class="attach-btn" for="id_attachment">ðŸ“Ž Ð¤Ð°Ð¹Ð»</label>
      <input class="file-attach-input" id="id_attachment" name="attachment" type="file">
      <span class="attach-name" id="attachment-name">Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½</span>
    </div>
    <button type="submit">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
  </form>
</div>

<script>
(function(){
  const box = document.getElementById('chat-box');
  const typingIndicator = document.getElementById('typing-indicator');
  const contentInput = document.getElementById('id_content');
  const form = document.getElementById('message-form');
  const imageInput = document.getElementById('id_image');
  const attachInput = document.getElementById('id_attachment');
  const imageName = document.getElementById('image-name');
  const attachmentName = document.getElementById('attachment-name');
  const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${wsProtocol}://${window.location.host}{{ ws_url }}`);
  const typingUrl = "{% url 'dialog-typing' dialog.id %}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function renderMessage(msg) {
    const isOwn = msg.author === "{{ user.username }}";
    const align = isOwn ? 'flex-end' : 'flex-start';
    const bg = isOwn ? '#3f341d' : '#23232b';
    const image = msg.image ? `<div><img src="${msg.image}" style="max-width:220px; border-radius:8px; margin-top:6px;"></div>` : '';
    const att = msg.attachment ? `<div style="margin-top:6px;"><a href="${msg.attachment}" target="_blank">ðŸ“Ž Ð’Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ</a></div>` : '';
    const html = `<div class="msg" data-id="${msg.id}" style="display:flex;flex-direction:column;align-items:${align};"><div style="font-size:12px;color:#a8a8a8;margin-bottom:4px;">${msg.author} Â· ${msg.created_at}</div><div style="display:inline-block;max-width:78%;background:${bg};border:1px solid rgba(212,175,55,0.25);padding:10px 12px;border-radius:12px;">${msg.content || ''}${image}${att}</div></div>`;
    box.insertAdjacentHTML('beforeend', html);
    box.scrollTop = box.scrollHeight;
  }

  ws.onmessage = (event) => {
    const payload = JSON.parse(event.data || '{}');
    if (payload.type === 'typing' && payload.author !== "{{ user.username }}") {
      typingIndicator.textContent = `${payload.author} Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚...`;
      setTimeout(() => {
        if (typingIndicator.textContent === `${payload.author} Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚...`) {
          typingIndicator.textContent = '';
        }
      }, 1800);
    }
    if (payload.type === 'message' && payload.message) {
      if (!document.querySelector(`.msg[data-id="${payload.message.id}"]`)) {
        renderMessage(payload.message);
      }
    }
  };

  if (contentInput) {
    let typingTimer;
    contentInput.addEventListener('input', () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        fetch(typingUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') || '' }
        }).catch(() => {});
      }, 250);
    });
  }

  if (imageInput && imageName) imageInput.addEventListener('change', () => { imageName.textContent = imageInput.files[0] ? imageInput.files[0].name : 'Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½'; });
  if (attachInput && attachmentName) attachInput.addEventListener('change', () => { attachmentName.textContent = attachInput.files[0] ? attachInput.files[0].name : 'Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½'; });

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      try {
        const response = await fetch(window.location.href, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || !data.ok) return;

        if (!document.querySelector(`.msg[data-id="${data.message.id}"]`)) {
          renderMessage(data.message);
        }
        ws.send(JSON.stringify({ type: 'message', message: data.message }));
        form.reset();
        imageName.textContent = 'Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½';
        attachmentName.textContent = 'Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½';
      } catch (_) {}
    });
  }

  box.scrollTop = box.scrollHeight;
})();
</script>
{% endblock %}
