{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<h2 class="page-title">Редактирование профиля</h2>

<div class="profile-container" style="display:flex; gap: 40px; margin-top:20px;">

    <!-- Левая колонка -->
    <div class="profile-left" style="width:250px; text-align:center;">
        {% if user.profile.avatar %}
            <img src="{{ user.profile.avatar.url }}" alt="Avatar"
                 style="width:200px; height:200px; border-radius:50%; object-fit:cover; border:2px solid #ccc;">
        {% else %}
            <img src="{% static user.profile.default_avatar %}" alt="Avatar"
                 style="width:200px; height:200px; border-radius:50%; object-fit:cover; border:2px solid #ccc;">
        {% endif %}

        <div style="margin-top:15px;">
            <a href="{% url 'profile' %}" class="btn"
               style="padding:10px 20px; background:#c19b2e; color:#0d0d10; border-radius:8px; text-decoration:none; display:block;">
                Назад к профилю
            </a>
        </div>
    </div>

    <!-- Правая колонка -->
    <div class="profile-right" style="flex:1; min-width:0;">

        <div class="card" style="max-width:520px; margin:0 auto;">
            <h3>Информация пользователя</h3>

            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Username -->
                <div style="margin-bottom:14px;">
                    <div style="margin-bottom:6px; font-weight:700;">Имя пользователя</div>
                    {{ u_form.username }}
                    {% if u_form.username.errors %}
                        <div style="color:#ff7b7b; font-size:12px; margin-top:6px;">
                            {{ u_form.username.errors }}
                        </div>
                    {% endif %}
                </div>

                <!-- Avatar -->
                <div style="display:flex; align-items:center; gap:15px; margin: 16px 0 10px;">
                    <div style="flex-shrink:0;">
                        {% if user.profile.avatar %}
                            <img id="avatarPreview" src="{{ user.profile.avatar.url }}"
                                 style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid #d4af37;">
                        {% else %}
                            <img id="avatarPreview" src="{% static user.profile.default_avatar %}"
                                 style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid #d4af37;">
                        {% endif %}
                    </div>

                    <div style="flex:1; min-width:0;">
                        <label for="id_avatar" class="header-btn" style="cursor:pointer; display:inline-block;">
                            Выбрать файл
                        </label>

                        <div id="fileName" style="margin-top:8px; font-size:12px; color:#aaa; word-break:break-word;">
                            Файл не выбран
                        </div>

                        {{ p_form.avatar }}

                        {% if p_form.avatar.errors %}
                            <div style="color:#ff7b7b; font-size:12px; margin-top:6px;">
                                {{ p_form.avatar.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% if user.profile.avatar %}
                <button type="submit" name="delete_avatar"
                        style="background:#3a3a45; color:#fff; margin-top:6px;">
                    Удалить аватар
                </button>
                {% endif %}

                <button type="submit" name="update_profile" style="margin-top:10px;">
                    Сохранить изменения
                </button>
            </form>
        </div>

        <div class="card" style="margin:20px auto 0; max-width:520px;">
            <h3>Смена пароля</h3>
            <form method="POST">
                {% csrf_token %}
                {{ pass_form.as_p }}
                <button type="submit" name="change_password" style="margin-top:10px;">Сменить пароль</button>
            </form>
        </div>

    </div>

</div>

<script>
  const input = document.getElementById('id_avatar');
  const preview = document.getElementById('avatarPreview');
  const fileName = document.getElementById('fileName');

  if (input) {
    input.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        fileName.textContent = 'Файл не выбран';
        return;
      }
      fileName.textContent = 'Выбрано: ' + file.name;
      preview.src = URL.createObjectURL(file);
    });
  }
</script>

<style>
.hidden-file-input { display: none; }

.profile-right input,
.profile-right textarea,
.profile-right select {
  width: 100%;
  box-sizing: border-box;
}
</style>

{% endblock %}
