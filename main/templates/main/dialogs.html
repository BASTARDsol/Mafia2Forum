{% extends 'main/base.html' %}
{% block content %}
<h2 class="page-title">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
<div id="dialogs-live-note" style="display:none; padding:10px; margin-bottom:12px; border:1px solid #d4af37; border-radius:10px; background:#1a1a20; color:#ffdb63;">üîî –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤. <a href="" onclick="location.reload(); return false;" style="color:#ffdb63; text-decoration:underline;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</a></div>

<div class="card">
  <h3 style="margin-top:0;">–î–∏–∞–ª–æ–≥–∏</h3>
  <div style="display:flex; flex-direction:column; gap:10px;">
    {% for dialog in dialogs %}
      <a href="{% url 'dialog-detail' dialog.id %}" style="display:block; padding:12px; border-radius:10px; background:#212129; border:1px solid rgba(212,175,55,0.2); position:relative;">
        <strong>
          {% for p in dialog.dialog_participants.all %}{% if p.user != user %}{{ p.user.username }}{% endif %}{% endfor %}
        </strong>
        <div style="font-size:12px; color:#9f9f9f; margin-top:4px;">–û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É</div>
        {% if dialog.unread_count %}
          <div style="position:absolute; right:12px; top:12px; font-size:12px; color:#ffdb63; display:flex; align-items:center; gap:6px;">
            <span>üîî</span>
            <span>{{ dialog.unread_author }}</span>
            <span class="notify-badge" style="position:static; min-width:16px; height:16px; font-size:10px;">{{ dialog.unread_count }}</span>
          </div>
        {% endif %}
      </a>
    {% empty %}
      <div>–î–∏–∞–ª–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
    {% endfor %}
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0;">–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h3>
  <div style="display:flex; flex-wrap:wrap; gap:8px;">
    {% for u in users_for_new_dialog %}
      <form method="post" action="{% url 'dialog-start' u.username %}" style="margin:0;">{% csrf_token %}<button class="header-btn btn-compact" type="submit" style="width:auto;">{{ u.username }}</button></form>
    {% endfor %}
  </div>
</div>
<script>
(function(){
  const note = document.getElementById('dialogs-live-note');
  const currentUserId = {% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %};
  window.addEventListener('site-realtime', (evt) => {
    const payload = evt.detail || {};
    if (payload.type !== 'dialog_message_created') return;
    if (Number(payload.actor_id) === Number(currentUserId)) return;
    if (note) note.style.display = 'block';
  });
})();
</script>

{% endblock %}
