{% extends "main/base.html" %}
{% load static %}

{% block content %}
<div class="topic-container">

    <!-- –¢–µ–º–∞ -->
    <div class="topic-header">
        <div>
            <h1 class="topic-title">{{ topic.title }}</h1>
            <span class="topic-meta">–ê–≤—Ç–æ—Ä: {{ topic.author.username }} | {{ topic.created_at|date:"d M Y H:i" }}</span>
        </div>
        {% if user == topic.author %}
        <form method="post" action="{% url 'topic-delete' topic.id %}">
            {% csrf_token %}
            <button type="submit" class="delete-topic-btn">–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É</button>
        </form>
        {% endif %}
    </div>

    {% if topic.image %}
    <div class="topic-image">
        <img src="{{ topic.image.url }}" alt="{{ topic.title }}">
    </div>
    {% endif %}

    {% if topic.description %}
    <div class="topic-description">{{ topic.description|linebreaks }}</div>
    {% endif %}

    <div class="topic-likes">‚ù§Ô∏è {{ topic.total_likes }} –≤—Å–µ–≥–æ –ª–∞–π–∫–æ–≤</div>

    <!-- –ü–æ—Å—Ç—ã -->
    <div class="posts-container">
        {% for post in posts %}
        <div class="post-card" id="post-{{ post.id }}">
            <div class="post-header">
                <div class="post-user">
                    <div class="avatar">{{ post.author.username|slice:":2"|upper }}</div>
                    <div class="user-info">
                        <strong>{{ post.author.username }}</strong>
                        <span class="post-date">{{ post.created_at|date:"d M Y H:i" }}</span>
                    </div>
                </div>
                {% if user == post.author %}
                <form method="post" action="{% url 'delete-post' post.id %}">
                    {% csrf_token %}
                    <button class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç">üóëÔ∏è</button>
                </form>
                {% endif %}
            </div>

            <div class="post-content">{{ post.content|linebreaks }}</div>
            {% if post.image %}
            <div class="post-image"><img src="{{ post.image.url }}" alt="Post image"></div>
            {% endif %}

            <div class="post-actions">
                {% if user.is_authenticated %}
                <button class="action-btn like-btn" data-post-id="{{ post.id }}">
                    {% if user in post.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %} <span class="like-count">{{ post.likes.count }}</span>
                </button>
                {% endif %}
                <button class="action-btn comment-btn" onclick="toggleReplies({{ post.id }})">
                    üí¨ {{ post.replies.count }}
                </button>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ -->
            <div id="replies-{{ post.id }}" class="replies-container" style="display:none; margin-top:10px;">
                {% include "main/comments_recursive.html" with comments=post.replies.all %}

                {% if user.is_authenticated %}
                <form method="post" action="{% url 'add-reply' post.id %}" enctype="multipart/form-data" class="reply-form">
                    {% csrf_token %}
                    <div class="reply-header">
                        <div class="avatar">{{ user.username|slice:":2"|upper }}</div>
                        <span>–û—Ç–≤–µ—Ç –Ω–∞ –ø–æ—Å—Ç {{ post.author.username }}</span>
                    </div>
                    <textarea name="content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="reply-textarea"></textarea>
                    <input type="file" name="image" class="reply-image-input">
                    <button type="submit" class="reply-btn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–µ–º–µ -->
    <div class="topic-comments">
        <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–µ–º–µ</h2>
        {% include "main/comments_recursive.html" with comments=comments %}

        {% if user.is_authenticated %}
        <form method="post" enctype="multipart/form-data" class="new-comment-form">
            {% csrf_token %}
            <div class="reply-header">
                <div class="avatar">{{ user.username|slice:":2"|upper }}</div>
                <span>–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
            </div>
            <textarea name="content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="reply-textarea"></textarea>
            <input type="file" name="image" class="reply-image-input">
            <button type="submit" class="reply-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
        {% else %}
        <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø–æ—Å—Ç—ã.</p>
        {% endif %}
    </div>

</div>

<script>
function toggleReplies(postId) {
    const replies = document.getElementById('replies-' + postId);
    replies.style.display = replies.style.display === 'none' ? 'block' : 'none';
}

document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const postId = button.dataset.postId || button.dataset.commentId;
        const isComment = !!button.dataset.commentId;
        const url = isComment ? `/react_comment/${postId}/` : `/react_post/${postId}/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const formData = new FormData();
        formData.append('reaction', button.innerText.includes('‚ù§Ô∏è') ? 'dislike' : 'like');

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            button.querySelector('.like-count').textContent = data.likes;
            button.innerHTML = (data.user_reaction === 'like' ? '‚ù§Ô∏è' : 'ü§ç') + ' ' + data.likes;
        }
    });
});
</script>
{% endblock %}
