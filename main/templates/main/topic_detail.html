{% extends "main/base.html" %}
{% load static %}

{% block content %}
<div class="topic-container">

  <!-- ===== –¢–ï–ú–ê ===== -->
  <div class="vk-card">

    <div class="vk-head">
      {% if topic.author.profile.avatar %}
        <img class="avatar" src="{{ topic.author.profile.avatar.url }}" alt="">
      {% else %}
        <img class="avatar" src="{% static topic.author.profile.default_avatar %}" alt="">
      {% endif %}

      <div class="vk-head-meta">
        <div class="vk-author"><a href="{% url 'public-profile' topic.author.username %}">{{ topic.author.username }}</a></div>
        <div class="vk-time">{{ topic.created_at|date:"d M Y H:i" }}</div>
      </div>

      {% if user == topic.author %}
        <form method="post" action="{% url 'topic-delete' topic.id %}">
          {% csrf_token %}
          <button type="submit" class="delete-topic-btn">–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É</button>
        </form>
      {% endif %}
    </div>

    <div class="vk-title">{{ topic.title }}</div>

    <div class="js-collapsible" data-collapsed="1">
      <div class="vk-text-inner">
        {{ topic.description|linebreaks }}
      </div>
      <button type="button" class="vk-showmore">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
    </div>

    {% if topic.image %}
      <div class="vk-media">
        <img src="{{ topic.image.url }}" alt="">
      </div>
    {% endif %}

    <!-- ACTIONS: ‚ù§Ô∏è (–∫–Ω–æ–ø–∫–∞) + üí¨ (—Ç–æ–ª—å–∫–æ —Å—á–µ—Ç—á–∏–∫) -->
    <div class="vk-actions">
      <button
        type="button"
        class="vk-action vk-like-btn {% if not user.is_authenticated %}is-disabled{% endif %}"
        data-topic-id="{{ topic.id }}"
        data-auth="{% if user.is_authenticated %}1{% else %}0{% endif %}"
      >
        <span class="vk-ico vk-like-icon">
          {% if user.is_authenticated and user in topic.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
        </span>
        <span class="vk-count vk-like-count">{{ topic.likes.count }}</span>
      </button>

      <!-- üí¨ –¢–û–õ–¨–ö–û —Å—á–µ—Ç—á–∏–∫ -->
      <div class="vk-action vk-comment-counter" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">
        <span class="vk-ico">üí¨</span>
        <span class="vk-count" id="topic-comment-total">
          {% if comment_total is not None %}{{ comment_total }}{% else %}{{ comments.count }}{% endif %}
        </span>
      </div>
    </div>
    <div class="subscription-row">
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'topic-subscribe' topic.id %}" style="margin:0;">
          {% csrf_token %}
          <button type="submit" class="icon-btn" style="margin:0;" title="{% if is_subscribed %}–û—Ç–ø–∏—Å–∞—Ç—å—Å—è{% else %}–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% endif %}">
            {% if is_subscribed %}üîï{% else %}üîî{% endif %}
          </button>
        </form>
      {% endif %}
      <span class="subscriber-pill">–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: {{ subscriber_count }}</span>
    </div>


    <!-- ===== –ö–û–ú–ú–ï–ù–¢–´ (—Å–ª–µ–≥–∫–∞ –≤–∏–¥–Ω—ã + –∫–Ω–æ–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç—å) ===== -->
    <div class="comments-preview js-comments-collapsed" id="topic-comments-block">
      <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–µ–º–µ</h2>

      <div class="comments-inner" id="topic-comments-root">
        {% include "main/comments_recursive.html" with comments=comments post_id=None %}
      </div>

      {% if comments %}
        <button type="button" class="comments-showmore">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
      {% endif %}

      {% if user.is_authenticated %}
      <form method="post" enctype="multipart/form-data" class="new-comment-form media-form">
        {% csrf_token %}

        <div class="media-row">
          <textarea name="content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="reply-textarea"></textarea>

          <input
            id="topic-comment-file"
            type="file"
            name="image"
            accept="image/*"
            class="media-file-input"
          >

          <label for="topic-comment-file" class="media-icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üìé</label>
        </div>

        <div class="media-preview" hidden>
          <img class="media-preview-img" alt="">
          <button type="button" class="media-remove-btn" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">‚úï</button>
        </div>

        <button type="submit" class="reply-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
      {% endif %}
    </div>

  </div>

  <!-- ===== –ü–û–°–¢–´ ===== -->
  <div class="posts-container">
    {% for post in posts %}
      <div class="post-card">

        <div class="post-header">
          <div class="post-user">
            {% if post.author.profile.avatar %}
              <img class="avatar" src="{{ post.author.profile.avatar.url }}" alt="">
            {% else %}
              <img class="avatar" src="{% static post.author.profile.default_avatar %}" alt="">
            {% endif %}

            <div class="user-info">
              <strong><a href="{% url 'public-profile' post.author.username %}">{{ post.author.username }}</a></strong>
              <span class="post-date">{{ post.created_at|date:"d M Y H:i" }}</span>
            </div>
          </div>
        </div>

        <div class="post-content">{{ post.content|linebreaks }}</div>

        {% if post.image %}
          <div class="post-image"><img src="{{ post.image.url }}" alt=""></div>
        {% endif %}

        <div class="post-actions">
          <button
            type="button"
            class="action-btn post-like-btn {% if not user.is_authenticated %}is-disabled{% endif %}"
            data-post-id="{{ post.id }}"
            data-auth="{% if user.is_authenticated %}1{% else %}0{% endif %}"
          >
            <span class="post-like-icon">
              {% if user.is_authenticated and user in post.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
            </span>
            <span class="like-count">{{ post.likes.count }}</span>
          </button>

          <button
            type="button"
            class="action-btn post-comments-toggle"
            data-target="#replies-{{ post.id }}"
          >
            üí¨ <span class="post-comment-count">{{ post.comments.count }}</span>
          </button>
        </div>

        <div id="replies-{{ post.id }}" class="post-replies" style="display:none;">
          {% include "main/comments_recursive.html" with comments=post.comments.all post_id=post.id %}
        </div>

      </div>
    {% endfor %}
  </div>

</div>

{% include "main/topic_detail_js.html" %}
{% endblock %}
