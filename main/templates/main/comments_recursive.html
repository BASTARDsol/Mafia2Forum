{% load static %}
{% load dict_filters %}
{% for comment in comments %}
  <div class="comment-wrap" id="comment-wrap-{{ comment.id }}">

    <div class="comment-card">
      <div class="comment-header">
        {% if comment.author.profile.avatar %}
          <img class="avatar rank-{{ comment.author.family_rank }}" src="{{ comment.author.profile.avatar.url }}" alt="">
        {% else %}
          <img class="avatar rank-{{ comment.author.family_rank }}" src="{% static comment.author.profile.default_avatar %}" alt="">
        {% endif %}

        <div class="comment-meta">
          <div class="comment-author"><a href="{% url 'public-profile' comment.author.username %}">{{ comment.author.username }}</a></div>
          <div class="comment-date">{{ comment.created_at|date:"d M Y H:i" }}</div>
        </div>
      </div>

      <div class="comment-text">{{ comment.content|linebreaks }}</div>

      {% if comment.image %}
        <img class="reply-image" src="{{ comment.image.url }}" alt="">
      {% endif %}

      <div class="comment-actions">

        <!-- ‚ù§Ô∏è –ª–∞–π–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <button
          type="button"
          class="comment-like-btn header-btn {% if not user.is_authenticated %}is-disabled{% endif %}"
          data-comment-id="{{ comment.id }}"
          data-auth="{% if user.is_authenticated %}1{% else %}0{% endif %}"
        >
          <span class="comment-like-icon" id="c-like-ico-{{ comment.id }}">
            {% if user.is_authenticated and comment.id in liked_comment_ids %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
          </span>
          <span class="comment-like-count" id="c-like-cnt-{{ comment.id }}">
            {% if comment_like_counts %}
              {{ comment_like_counts|get_item:comment.id|default:0 }}
            {% else %}
              {{ comment.likes_count|default:0 }}
            {% endif %}
          </span>
        </button>

        {% if user.is_authenticated and not topic.is_closed %}
          <button
            type="button"
            class="comment-reply-toggle"
            data-target="#reply-form-{{ comment.id }}"
          >
            –û—Ç–≤–µ—Ç–∏—Ç—å
          </button>
        {% endif %}

        {% if user.is_authenticated and user == comment.author %}
          <form method="post" action="{% url 'comment-delete' comment.id %}" class="inline-form comment-delete-form" data-comment-id="{{ comment.id }}">
            {% csrf_token %}
            <button type="submit" class="header-btn danger-btn js-comment-delete">–£–¥–∞–ª–∏—Ç—å</button>
          </form>
        {% endif %}

      </div>

      {% if user.is_authenticated and not topic.is_closed %}
        <form
          id="reply-form-{{ comment.id }}"
          method="post"
          enctype="multipart/form-data"
          class="reply-form media-form"
          style="display:none;"
        >
          {% csrf_token %}
          <div class="media-row">
            <textarea name="content" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." class="reply-textarea"></textarea>

            <input
              id="reply-file-{{ comment.id }}"
              type="file"
              name="image"
              accept="image/*"
              class="media-file-input"
            >
            <label for="reply-file-{{ comment.id }}" class="media-icon-btn" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üìé</label>
          </div>

          <div class="media-preview" hidden>
            <img class="media-preview-img" alt="">
            <button type="button" class="media-remove-btn" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">‚úï</button>
          </div>

          <input type="hidden" name="parent_id" value="{{ comment.id }}">
          {% if post_id %}
            <input type="hidden" name="post_id" value="{{ post_id }}">
          {% endif %}

          <button type="submit" class="reply-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      {% endif %}

    </div>

    {% if comment.replies.all %}
      <div class="replies-container" id="replies-{{ comment.id }}">
        {% include "main/comments_recursive.html" with comments=comment.replies.all post_id=post_id %}
      </div>
    {% endif %}

  </div>
{% endfor %}
