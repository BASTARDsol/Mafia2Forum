{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Gli Custodi ‚Äî RP Forum</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="{% static 'css/style.css' %}">

<style>
html, body { height: 100%; margin: 0; padding: 0; }
body { display: flex; flex-direction: column; min-height: 100vh; background: #0d0d10; color: #f5e6c4; font-family: 'Open Sans', sans-serif; }
a { color: #d4af37; text-decoration: none; transition: 0.2s; }
a:hover { color: #ffcc00; text-decoration: underline; }
.container { flex: 1; display: flex; flex-direction: column; width: 950px; max-width: 95%; margin: 0 auto; padding: 20px; }
header { background: #1c1c22; border-radius: 8px; padding: 12px 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); }
.header-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
.header-left, .header-right { display: flex; align-items: center; gap: 10px; }
.header-right { margin-left: auto; }
.online-ticker{max-width:200px;overflow:hidden;white-space:nowrap;border:1px solid #d4af37;border-radius:999px;padding:6px 12px;color:#ffdb63;background:#15151b;font-size:12px;}
.online-ticker-track{display:inline-block;padding-left:100%;animation:ticker 14s linear infinite;}
@keyframes ticker{0%{transform:translateX(0);}100%{transform:translateX(-100%);}}
.header-btn { background-color: #d4af37; color: #0d0d10; padding: 8px 15px; border-radius: 6px; font-weight: 700; text-decoration: none; transition: all 0.3s ease; white-space: nowrap; }
.header-btn:hover { background-color: #c19b2e; transform: scale(1.05); box-shadow: 0 0 10px #d4af37; }
.icon-btn { width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: #2a2a30; color: #f5e6c4; font-size: 20px; border: 1px solid #d4af37; position: relative; overflow: visible; }
.icon-btn:hover { text-decoration: none; color: #ffcc00; box-shadow: 0 0 10px rgba(212,175,55,0.5); }
.notify-badge {
    display:inline-flex; min-width:18px; height:18px; border-radius:999px; background:#ff4d6d; color:#fff;
    font-size:11px; align-items:center; justify-content:center; padding:0 5px; position:absolute; top:-9px; right:-9px;
    border: 1px solid #0d0d10;
}
.avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #d4af37; padding: 2px; transition: transform 0.2s, box-shadow 0.2s; }
.avatar:hover { transform: scale(1.15); box-shadow: 0 0 10px #d4af37; }
.card, .post-card, .comment-card, .new-post-card { background: linear-gradient(145deg, #1c1c22, #2a2a30); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 6px 12px rgba(0,0,0,0.7); transition: transform 0.3s, box-shadow 0.3s; }
.card:hover, .post-card:hover, .comment-card:hover, .new-post-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(212,175,55,0.6); }
input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 6px; border: none; font-family: 'Open Sans', sans-serif; font-size: 14px; background: #2a2a30; color: #f5e6c4; }
textarea { resize: none; }
textarea:focus, input:focus, select:focus { outline: none; border-color: #d4af37; background: #262632; }
button { padding: 12px; margin-bottom: 12px; border-radius: 6px; border: none; font-family: 'Open Sans', sans-serif; font-size: 14px; background-color: #d4af37; color: #0d0d10; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
button:hover { background-color: #c19b2e; transform: scale(1.05); box-shadow: 0 0 10px #d4af37; }
form button { width: 100%; }
h2.page-title { font-family: 'Merriweather', serif; font-size: 32px; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px; }
footer { text-align: center; padding: 15px 0; background: #1c1c22; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); margin-top: auto; }
.forum-table { width: 100%; border-collapse: collapse; background: #1c1c22; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.6); }
.forum-table td { padding: 12px; border-bottom: 1px solid #2f2f36; text-align:center; }
.forum-table tr:hover { background: #24242b; }
.content-area { display: flex; gap: 20px; align-items: flex-start; }
.content-main{ flex: 1; min-width: 0; }
.content-sidebar{ width: 220px; flex: 0 0 220px; position: sticky; top: 20px; }
@media (max-width: 768px) {
    .header-container { flex-direction: column; gap: 10px; }
    .header-left, .header-right { justify-content: center; margin-left: 0; }
    .container { width: 95%; padding: 10px; flex-direction: column; }
    .content-area { flex-direction: column; }
    .content-sidebar{ width: 100%; flex: 0 0 auto; position: static; top: auto; }
}
</style>
</head>

<body>
<div class="container">

<header>
    <div class="header-container">
        <div class="header-left">
            {% if user.is_authenticated %}
                <div class="online-ticker" id="online-ticker" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω">
                    <span class="online-ticker-track" id="online-ticker-track">{% if online_users %}–û–Ω–ª–∞–π–Ω: {% for online_user in online_users %}{{ online_user.username }}{% if not forloop.last %} ‚Ä¢ {% endif %}{% endfor %}{% else %}–û–Ω–ª–∞–π–Ω: –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ{% endif %}</span>
                </div>
                <a href="{% url 'profile' %}">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" class="avatar" alt="">
                    {% else %}
                        <img src="{% static user.profile.default_avatar %}" class="avatar" alt="">
                    {% endif %}
                </a>
                <a href="{% url 'notifications' %}" class="icon-btn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" id="notifications-icon">
                    üîî{% if unread_notifications_count > 0 %}<span class="notify-badge" id="notifications-badge">{{ unread_notifications_count }}</span>{% endif %}
                </a>
                <a href="{% url 'dialogs' %}" class="icon-btn" title="–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è" id="messages-icon">
                    üí¨{% if unread_messages_count > 0 %}<span class="notify-badge" id="messages-badge">{{ unread_messages_count }}</span>{% endif %}
                </a>
                <a href="{% url 'logout' %}" class="header-btn pulse-button">–í—ã–π—Ç–∏</a>
            {% else %}
                <a href="{% url 'login' %}" class="header-btn pulse-button">–í–æ–π—Ç–∏</a>
                <a href="{% url 'register' %}" class="header-btn pulse-button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            {% endif %}
        </div>

        <div class="header-right">
            {% if user.is_authenticated %}
                <a href="{% url 'create_topic_simple' %}" class="header-btn pulse-button">–°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</a>
            {% endif %}
        </div>
    </div>
</header>

<main class="content-area">
    <div class="content-main">
        {% block content %}{% endblock %}
    </div>

    {% with name=request.resolver_match.url_name %}
        {% if name != 'login' and name != 'register' and name != 'change-password' %}
        <div class="content-sidebar">
            <table class="forum-table">
                <tbody>
                    <tr><td><a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a></td></tr>
                    <tr><td><a href="{% url 'news' %}">–ù–æ–≤–æ—Å—Ç–∏</a></td></tr>
                    <tr><td><a href="{% url 'family-hq' %}">–®—Ç–∞–± —Å–µ–º—å–∏</a></td></tr>
                    <tr><td><span style="color:#888;">–î—Ä—É–≥–æ–µ</span></td></tr>
                </tbody>
            </table>
        </div>
        {% endif %}
    {% endwith %}
</main>

<footer>
    RP Forum Gli Custodi 2026
    <br>
    <a href="{% url 'terms' %}">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> |
    <a href="{% url 'privacy' %}">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
</footer>

</div>
<script>
(function(){
  const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const notifIcon = document.getElementById('notifications-icon');
  const messagesIcon = document.getElementById('messages-icon');
  if (notifIcon && messagesIcon) {
  try {
    const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/notifications/`);
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data || '{}');
      if (typeof data.unread_notifications_count === 'number') {
        let badge = document.getElementById('notifications-badge');
        if (data.unread_notifications_count > 0) {
          if (!badge) {
            badge = document.createElement('span');
            badge.id = 'notifications-badge';
            badge.className = 'notify-badge';
            notifIcon.appendChild(badge);
          }
          badge.textContent = data.unread_notifications_count;
        } else if (badge) {
          badge.remove();
        }
      }
      if (typeof data.unread_messages_count === 'number') {
        let badge = document.getElementById('messages-badge');
        if (data.unread_messages_count > 0) {
          if (!badge) {
            badge = document.createElement('span');
            badge.id = 'messages-badge';
            badge.className = 'notify-badge';
            messagesIcon.appendChild(badge);
          }
          badge.textContent = data.unread_messages_count;
        } else if (badge) {
          badge.remove();
        }
      }
    };
  } catch (e) {
    console.warn('Notifications websocket unavailable', e);
  }
  }

  const tickerTrack = document.getElementById('online-ticker-track');
  try {
    const siteWs = new WebSocket(`${wsProtocol}://${window.location.host}/ws/site/`);
    siteWs.onmessage = (event) => {
      const payload = JSON.parse(event.data || '{}');
      if (payload.type === 'online_users' && tickerTrack) {
        const users = Array.isArray(payload.users) ? payload.users : [];
        tickerTrack.textContent = users.length ? `–û–Ω–ª–∞–π–Ω: ${users.join(' ‚Ä¢ ')}` : '–û–Ω–ª–∞–π–Ω: –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ';
      }
      window.dispatchEvent(new CustomEvent('site-realtime', {detail: payload}));
    };
  } catch (e) {
    console.warn('Site websocket unavailable', e);
  }

})();
</script>
</body>
</html>
