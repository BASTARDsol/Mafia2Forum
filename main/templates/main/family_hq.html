{% extends 'main/base.html' %}

{% block content %}
<style>
.hq-grid{display:grid;gap:16px;}
.hq-item{background:#15151b;border:1px solid #30303a;border-radius:12px;padding:12px;}
.hq-meta{font-size:12px;color:#9696a3;}
.task-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.task-actions form{margin:0;display:inline-flex;align-items:center;gap:8px;}
.task-btn{width:auto!important;padding:7px 11px!important;margin:0!important;font-size:12px!important;}
.proof-preview img{max-width:150px;border-radius:8px;border:1px solid #43434f;}
</style>

<h2 class="page-title">üèõÔ∏è –®—Ç–∞–± —Å–µ–º—å–∏</h2>

<div class="card" style="margin-top:20px;">
  <h3 style="margin-top:0; color:#d4af37;">üéØ –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–µ–º—å–∏</h3>
  {% if family_ops %}
    <div class="hq-grid">
      {% for op in family_ops %}
        <div class="hq-item">
          <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <strong>{{ op.title }}</strong>
            <span class="hq-meta">{{ op.get_status_display }}</span>
          </div>
          <div style="font-size:13px; color:#ddd; margin-top:4px;">{{ op.objective|truncatechars:160 }}</div>
          <div class="hq-meta" style="margin-top:6px;">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä: {{ op.coordinator.username }}{% if op.scheduled_for %} ¬∑ {{ op.scheduled_for|date:"d.m.Y H:i" }}{% endif %}</div>
        </div>
      {% endfor %}
    </div>
  {% else %}<div style="color:#888;">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>{% endif %}
  {% if can_manage_family_data %}
    <details style="margin-top:10px;"><summary style="cursor:pointer; color:#ffdb63;">+ –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</summary>
      <form method="post" action="{% url 'create-family-operation' %}" style="margin-top:10px;">{% csrf_token %}
        <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏" required>
        <textarea name="objective" rows="3" placeholder="–¶–µ–ª—å –æ–ø–µ—Ä–∞—Ü–∏–∏" required></textarea>
        <input type="datetime-local" name="scheduled_for">
        <select name="status"><option value="planning">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option><option value="active">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option><option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option><option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option></select>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
      </form>
    </details>
  {% endif %}
</div>

<div class="card" style="margin-top:20px;">
  <h3 style="margin-top:0; color:#d4af37;">üïµÔ∏è –î–æ—Å—å–µ</h3>
  {% if dossiers %}
    <div class="hq-grid">
      {% for dossier in dossiers %}
        <div class="hq-item">
          <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <strong>{{ dossier.target_name }}</strong>
            <span class="hq-meta">{{ dossier.get_side_display }} ¬∑ {{ dossier.get_threat_level_display }}</span>
          </div>
          <div style="font-size:13px; color:#ddd; margin-top:4px;">{{ dossier.notes|truncatechars:160 }}</div>
          <div class="hq-meta" style="margin-top:6px;">–û–±–Ω–æ–≤–∏–ª: {{ dossier.author.username }}</div>
        </div>
      {% endfor %}
    </div>
  {% else %}<div style="color:#888;">–î–æ—Å—å–µ –ø–æ–∫–∞ –ø—É—Å—Ç—ã.</div>{% endif %}
  {% if can_manage_family_data %}
    <details style="margin-top:10px;"><summary style="cursor:pointer; color:#ffdb63;">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—å–µ</summary>
      <form method="post" action="{% url 'create-faction-dossier' %}" style="margin-top:10px;">{% csrf_token %}
        <input type="text" name="target_name" placeholder="–ò–º—è/—Ñ—Ä–∞–∫—Ü–∏—è" required>
        <select name="side"><option value="ally">–°–æ—é–∑–Ω–∏–∫</option><option value="neutral">–ù–µ–π—Ç—Ä–∞–ª</option><option value="enemy">–í—Ä–∞–≥</option></select>
        <select name="threat_level"><option value="low">–ù–∏–∑–∫–∏–π</option><option value="medium">–°—Ä–µ–¥–Ω–∏–π</option><option value="high">–í—ã—Å–æ–∫–∏–π</option><option value="critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option></select>
        <textarea name="notes" rows="3" placeholder="–ù–∞–±–ª—é–¥–µ–Ω–∏—è" required></textarea>
        <input type="url" name="evidence_link" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—å–µ</button>
      </form>
    </details>
  {% endif %}
</div>

<div class="card" style="margin-top:20px;">
  <h3 style="margin-top:0; color:#d4af37;">üìã –ü–æ—Ä—É—á–µ–Ω–∏—è —Å–µ–º—å–∏</h3>
  {% if family_tasks %}
    <div class="hq-grid">
      {% for task in family_tasks %}
        <div class="hq-item">
          <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <strong>{{ task.title }}</strong>
            <span class="hq-meta">{{ task.get_status_display }} ¬∑ +{{ task.reward_points }} RP</span>
          </div>
          <div style="font-size:13px; color:#ddd; margin-top:4px;">{{ task.description|truncatechars:160 }}</div>
          <div class="hq-meta" style="margin-top:5px;">
            –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {% if task.assignee %}{{ task.assignee.username }}{% else %}<span style="color:#ffd37a;">–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>{% endif %}
            {% if task.due_at %} ¬∑ –¥–µ–¥–ª–∞–π–Ω {{ task.due_at|date:"d.m.Y H:i" }}{% endif %}
          </div>
          {% if task.completion_proof %}
          <div class="proof-preview" style="margin-top:8px;">
            <a href="{{ task.completion_proof.url }}" target="_blank"><img src="{{ task.completion_proof.url }}" alt="proof"></a>
          </div>
          {% endif %}
          <div class="task-actions">
            {% if user.is_authenticated and task.status == 'open' %}
              <form method="post" action="{% url 'claim-family-task' task.id %}">{% csrf_token %}<button type="submit" class="task-btn">–í–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button></form>
            {% endif %}
            {% if user.is_authenticated and task.status != 'done' %}
              {% if task.assignee_id == user.id or can_manage_family_data %}
              <form method="post" enctype="multipart/form-data" action="{% url 'complete-family-task' task.id %}" onsubmit="return confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏? –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ —Ñ–æ—Ç–æ/—Å–∫—Ä–∏–Ω.');">
                {% csrf_token %}
                <label class="attach-btn" for="proof-{{ task.id }}">üìé –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</label>
                <input class="file-attach-input" id="proof-{{ task.id }}" type="file" name="completion_proof" accept="image/*" required>
                <button type="submit" class="task-btn">–ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É</button>
              </form>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}<div style="color:#888;">–ü–æ—Ä—É—á–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>{% endif %}
  {% if can_manage_family_data %}
    <details style="margin-top:10px;"><summary style="cursor:pointer; color:#ffdb63;">+ –í—ã–¥–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏–µ</summary>
      <form method="post" action="{% url 'create-family-task' %}" style="margin-top:10px;">{% csrf_token %}
        <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—É—á–µ–Ω–∏—è" required>
        <textarea name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required></textarea>
        <select name="assignee"><option value="">–ë–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (—Å–≤–æ–±–æ–¥–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ)</option>{% for forum_user in family_members %}<option value="{{ forum_user.id }}">{{ forum_user.username }} ({{ forum_user.get_family_rank_display }})</option>{% endfor %}</select>
        <input type="datetime-local" name="due_at">
        <select name="status"><option value="open">–û—Ç–∫—Ä—ã—Ç–∞</option><option value="in_progress">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</option><option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option></select>
        <input type="number" name="reward_points" min="0" value="0" placeholder="RP –æ—á–∫–∏">
        <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Ä—É—á–µ–Ω–∏–µ</button>
      </form>
    </details>
  {% endif %}
</div>
{% endblock %}
