<script>
(function () {
  // ===== CSRF =====
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // ===== Ð¢Ð•ÐšÐ¡Ð¢ Ð¢Ð•ÐœÐ«: Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐµÑ‰Ñ‘ =====
  document.querySelectorAll(".js-collapsible").forEach((box) => {
    const btn = box.querySelector(".vk-showmore");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const collapsed = box.getAttribute("data-collapsed") === "1";
      box.setAttribute("data-collapsed", collapsed ? "0" : "1");
      btn.textContent = collapsed ? "Ð¡ÐºÑ€Ñ‹Ñ‚ÑŒ" : "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐµÑ‰Ñ‘";
    });
  });

  // ===== ÐšÐžÐœÐœÐ•ÐÐ¢Ð«: Ð¿Ñ€ÐµÐ²ÑŒÑŽ + Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ/ÑÐ²ÐµÑ€Ð½ÑƒÑ‚ÑŒ =====
  document.querySelectorAll(".comments-preview").forEach((block) => {
    const btn = block.querySelector(".comments-showmore");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const isCollapsed = block.classList.contains("js-comments-collapsed");
      block.classList.toggle("js-comments-collapsed", !isCollapsed);
      block.classList.toggle("js-comments-expanded", isCollapsed);
      btn.textContent = isCollapsed ? "Ð¡Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸" : "Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸";
    });
  });

  // ===== ÐžÐ¢Ð’Ð•Ð¢Ð˜Ð¢Ð¬: Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ/Ð·Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ =====
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".comment-reply-toggle");
    if (!btn) return;

    e.preventDefault();
    const sel = btn.getAttribute("data-target");
    const form = sel ? document.querySelector(sel) : null;
    if (!form) return;

    const isHidden = form.style.display === "none" || !form.style.display;
    form.style.display = isHidden ? "block" : "none";
    if (isHidden) {
      const ta = form.querySelector("textarea");
      if (ta) ta.focus();
    }
  });

  // ===== MEDIA PREVIEW (Ð´Ð»Ñ Ð²ÑÐµÑ… media-form: Ð¸ Ð½Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð°, Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹) =====
  function bindMediaForm(form) {
    const input = form.querySelector('input[type="file"].media-file-input');
    const preview = form.querySelector(".media-preview");
    const img = form.querySelector(".media-preview-img");
    const remove = form.querySelector(".media-remove-btn");

    if (!input || !preview || !img || !remove) return;

    input.addEventListener("change", () => {
      const file = input.files && input.files[0];
      if (!file) {
        preview.hidden = true;
        img.src = "";
        return;
      }
      img.src = URL.createObjectURL(file);
      preview.hidden = false;
    });

    remove.addEventListener("click", () => {
      input.value = "";
      preview.hidden = true;
      img.src = "";
    });
  }

  document.querySelectorAll("form.media-form").forEach(bindMediaForm);

  // ===== AJAX: Ð»Ð°Ð¹Ðº Ñ‚ÐµÐ¼Ñ‹ =====
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".vk-like-btn");
    if (!btn) return;

    const auth = btn.getAttribute("data-auth") === "1";
    if (!auth) return;

    const topicId = btn.getAttribute("data-topic-id");
    if (!topicId) return;

    try {
      const res = await fetch(`/toggle_topic_like/${topicId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();

      const ico = btn.querySelector(".vk-like-icon");
      const cnt = btn.querySelector(".vk-like-count");
      if (ico) ico.textContent = data.liked ? "â¤ï¸" : "ðŸ¤";
      if (cnt) cnt.textContent = data.likes;
    } catch (err) {
      console.error(err);
    }
  });

  // ===== AJAX: Ð»Ð°Ð¹Ðº Ð¿Ð¾ÑÑ‚Ð° =====
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".post-like-btn");
    if (!btn) return;

    const auth = btn.getAttribute("data-auth") === "1";
    if (!auth) return;

    const postId = btn.getAttribute("data-post-id");
    if (!postId) return;

    try {
      const res = await fetch(`/toggle_post_like/${postId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();

      const ico = btn.querySelector(".post-like-icon");
      const cnt = btn.querySelector(".like-count");
      if (ico) ico.textContent = data.liked ? "â¤ï¸" : "ðŸ¤";
      if (cnt) cnt.textContent = data.likes;
    } catch (err) {
      console.error(err);
    }
  });

  // ===== AJAX: Ð»Ð°Ð¹Ðº ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ =====
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".comment-like-btn");
    if (!btn) return;

    const auth = btn.getAttribute("data-auth") === "1";
    if (!auth) return;

    const commentId = btn.getAttribute("data-comment-id");
    if (!commentId) return;

    try {
      const res = await fetch(`/toggle_comment_like/${commentId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();

      const ico = document.getElementById(`c-like-ico-${commentId}`);
      const cnt = document.getElementById(`c-like-cnt-${commentId}`);
      if (ico) ico.textContent = data.liked ? "â¤ï¸" : "ðŸ¤";
      if (cnt) cnt.textContent = data.likes;
    } catch (err) {
      console.error(err);
    }
  });

  // ===== ÐŸÐ¾ÑÑ‚-ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ñ‹: Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ/ÑÐºÑ€Ñ‹Ñ‚ÑŒ Ð±Ð»Ð¾Ðº (ÐºÐ°Ðº Ð±Ñ‹Ð»Ð¾) =====
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".post-comments-toggle");
    if (!btn) return;

    const targetSel = btn.getAttribute("data-target");
    const target = targetSel ? document.querySelector(targetSel) : null;
    if (!target) return;

    const isHidden = target.style.display === "none" || !target.style.display;
    target.style.display = isHidden ? "block" : "none";
  });
})();
</script>
