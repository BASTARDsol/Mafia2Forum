<script>
(function () {
  // ===== CSRF =====
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // ===== Ð¢Ð•ÐšÐ¡Ð¢ Ð¢Ð•ÐœÐ«: Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐµÑ‰Ñ‘ =====
  document.querySelectorAll(".js-collapsible").forEach((box) => {
    const btn = box.querySelector(".vk-showmore");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const collapsed = box.getAttribute("data-collapsed") === "1";
      box.setAttribute("data-collapsed", collapsed ? "0" : "1");
      btn.textContent = collapsed ? "Ð¡ÐºÑ€Ñ‹Ñ‚ÑŒ" : "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐµÑ‰Ñ‘";
    });
  });

  // ===== ÐšÐžÐœÐœÐ•ÐÐ¢Ð«: Ð¿Ñ€ÐµÐ²ÑŒÑŽ + Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ/ÑÐ²ÐµÑ€Ð½ÑƒÑ‚ÑŒ =====
  document.querySelectorAll(".comments-preview").forEach((block) => {
    const btn = block.querySelector(".comments-showmore");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const isCollapsed = block.classList.contains("js-comments-collapsed");
      block.classList.toggle("js-comments-collapsed", !isCollapsed);
      block.classList.toggle("js-comments-expanded", isCollapsed);
      btn.textContent = isCollapsed ? "Ð¡Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸" : "Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸";
    });
  });

  // ===== ÐžÐ¢Ð’Ð•Ð¢Ð˜Ð¢Ð¬: Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ/Ð·Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ =====
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".comment-reply-toggle");
    if (!btn) return;

    e.preventDefault();
    const sel = btn.getAttribute("data-target");
    const form = sel ? document.querySelector(sel) : null;
    if (!form) return;

    const isHidden = form.style.display === "none" || !form.style.display;
    form.style.display = isHidden ? "block" : "none";
    if (isHidden) {
      const ta = form.querySelector("textarea");
      if (ta) ta.focus();
    }
  });

  // ===== MEDIA PREVIEW (Ð´Ð»Ñ Ð²ÑÐµÑ… media-form: Ð¸ Ð½Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð°, Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹) =====
  function bindMediaForm(form) {
    const input = form.querySelector('input[type="file"].media-file-input');
    const preview = form.querySelector(".media-preview");
    const img = form.querySelector(".media-preview-img");
    const remove = form.querySelector(".media-remove-btn");

    if (!input || !preview || !img || !remove) return;

    input.addEventListener("change", () => {
      const file = input.files && input.files[0];
      if (!file) {
        preview.hidden = true;
        img.src = "";
        return;
      }
      img.src = URL.createObjectURL(file);
      preview.hidden = false;
    });

    remove.addEventListener("click", () => {
      input.value = "";
      preview.hidden = true;
      img.src = "";
    });
  }

  document.querySelectorAll("form.media-form").forEach(bindMediaForm);

  // ===== AJAX: Ð»Ð°Ð¹Ðº Ñ‚ÐµÐ¼Ñ‹ =====
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".vk-like-btn");
    if (!btn) return;

    const auth = btn.getAttribute("data-auth") === "1";
    if (!auth) return;

    const topicId = btn.getAttribute("data-topic-id");
    if (!topicId) return;

    try {
      const res = await fetch(`/toggle_topic_like/${topicId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();

      const ico = btn.querySelector(".vk-like-icon");
      const cnt = btn.querySelector(".vk-like-count");
      if (ico) ico.textContent = data.liked ? "â¤ï¸" : "ðŸ¤";
      if (cnt) cnt.textContent = data.likes;
    } catch (err) {
      console.error(err);
    }
  });

  // ===== AJAX: Ð»Ð°Ð¹Ðº Ð¿Ð¾ÑÑ‚Ð° =====
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".post-like-btn");
    if (!btn) return;

    const auth = btn.getAttribute("data-auth") === "1";
    if (!auth) return;

    const postId = btn.getAttribute("data-post-id");
    if (!postId) return;

    try {
      const res = await fetch(`/toggle_post_like/${postId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();

      const ico = btn.querySelector(".post-like-icon");
      const cnt = btn.querySelector(".like-count");
      if (ico) ico.textContent = data.liked ? "â¤ï¸" : "ðŸ¤";
      if (cnt) cnt.textContent = data.likes;
    } catch (err) {
      console.error(err);
    }
  });

  // ===== AJAX: Ð»Ð°Ð¹Ðº ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ =====
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".comment-like-btn");
    if (!btn) return;

    const auth = btn.getAttribute("data-auth") === "1";
    if (!auth) return;

    const commentId = btn.getAttribute("data-comment-id");
    if (!commentId) return;

    try {
      const res = await fetch(`/toggle_comment_like/${commentId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();

      const ico = document.getElementById(`c-like-ico-${commentId}`);
      const cnt = document.getElementById(`c-like-cnt-${commentId}`);
      if (ico) ico.textContent = data.liked ? "â¤ï¸" : "ðŸ¤";
      if (cnt) cnt.textContent = data.likes;
    } catch (err) {
      console.error(err);
    }
  });



  // ===== AJAX: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ²/Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð±ÐµÐ· Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ =====
  document.addEventListener("submit", async (e) => {
    const form = e.target.closest("form.media-form");
    if (!form) return;

    e.preventDefault();
    const formData = new FormData(form);

    try {
      const res = await fetch(window.location.href, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      });
      const data = await res.json();
      if (!res.ok || !data.ok) return;

      if (data.parent_id) {
        const parentReplies = document.getElementById(`replies-${data.parent_id}`);
        if (parentReplies) {
          parentReplies.insertAdjacentHTML("beforeend", data.html);
        }
      } else if (data.post_id) {
        const replies = document.querySelector(`#replies-${data.post_id}`);
        if (replies) replies.insertAdjacentHTML("beforeend", data.html);
      } else {
        const root = document.getElementById("topic-comments-root");
        if (root) root.insertAdjacentHTML("beforeend", data.html);
      }

      const cnt = document.getElementById("topic-comment-total");
      if (cnt) cnt.textContent = String((parseInt(cnt.textContent || "0", 10) || 0) + 1);

      form.reset();
      const preview = form.querySelector('.media-preview');
      const img = form.querySelector('.media-preview-img');
      if (preview) preview.hidden = true;
      if (img) img.src = '';
      if (form.classList.contains('reply-form')) {
        form.style.display = 'none';
      }
    } catch (err) {
      console.error(err);
    }
  });

  // ===== AJAX: ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ñ Ð±ÐµÐ· Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ =====
  document.addEventListener("submit", async (e) => {
    const form = e.target.closest(".comment-delete-form");
    if (!form) return;

    e.preventDefault();
    const commentId = form.getAttribute('data-comment-id');

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken,
        }
      });
      const data = await res.json();
      if (!res.ok || !data.ok) return;
      const wrap = document.getElementById(`comment-wrap-${commentId}`);
      if (wrap) wrap.remove();
      const cnt = document.getElementById("topic-comment-total");
      if (cnt) cnt.textContent = String(Math.max(0, (parseInt(cnt.textContent || "0", 10) || 0) - 1));
    } catch (err) {
      console.error(err);
    }
  });



  // ===== WebSocket realtime ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð¿Ð¾ Ñ‚ÐµÐ¼Ðµ (Ð²ÐµÑÑŒ ÑÐ°Ð¹Ñ‚) =====
  const currentUserId = {% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %};
  window.addEventListener('site-realtime', (evt) => {
    const payload = evt.detail || {};
    const currentTopicId = {{ topic.id }};
    if (!payload.topic_id || Number(payload.topic_id) !== Number(currentTopicId)) return;

    if (payload.type === 'comment_created') {
      if (Number(payload.actor_id) === Number(currentUserId)) return;
      if (payload.parent_id) {
        const parentReplies = document.getElementById(`replies-${payload.parent_id}`);
        if (parentReplies && payload.html) parentReplies.insertAdjacentHTML('beforeend', payload.html);
      } else if (payload.post_id) {
        const replies = document.querySelector(`#replies-${payload.post_id}`);
        if (replies && payload.html) replies.insertAdjacentHTML('beforeend', payload.html);
      } else {
        const root = document.getElementById('topic-comments-root');
        if (root && payload.html) root.insertAdjacentHTML('beforeend', payload.html);
      }
      const cnt = document.getElementById('topic-comment-total');
      if (cnt) cnt.textContent = String((parseInt(cnt.textContent || '0', 10) || 0) + 1);
    }

    if (payload.type === 'comment_deleted') {
      if (Number(payload.actor_id) === Number(currentUserId)) return;
      const wrap = document.getElementById(`comment-wrap-${payload.comment_id}`);
      if (wrap) wrap.remove();
      const cnt = document.getElementById('topic-comment-total');
      if (cnt) cnt.textContent = String(Math.max(0, (parseInt(cnt.textContent || '0', 10) || 0) - 1));
    }

    if (payload.type === 'topic_liked') {
      const cnt = document.querySelector('.vk-like-count');
      if (cnt && typeof payload.likes !== 'undefined') cnt.textContent = payload.likes;
    }

    if (payload.type === 'post_liked') {
      const btn = document.querySelector(`.post-like-btn[data-post-id="${payload.post_id}"]`);
      const cnt = btn ? btn.querySelector('.like-count') : null;
      if (cnt && typeof payload.likes !== 'undefined') cnt.textContent = payload.likes;
    }

    if (payload.type === 'comment_liked') {
      const cnt = document.getElementById(`c-like-cnt-${payload.comment_id}`);
      if (cnt && typeof payload.likes !== 'undefined') cnt.textContent = payload.likes;
    }
  });

  // ===== ÐŸÐ¾ÑÑ‚-ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ñ‹: Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ/ÑÐºÑ€Ñ‹Ñ‚ÑŒ Ð±Ð»Ð¾Ðº (ÐºÐ°Ðº Ð±Ñ‹Ð»Ð¾) =====
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".post-comments-toggle");
    if (!btn) return;

    const targetSel = btn.getAttribute("data-target");
    const target = targetSel ? document.querySelector(targetSel) : null;
    if (!target) return;

    const isHidden = target.style.display === "none" || !target.style.display;
    target.style.display = isHidden ? "block" : "none";
  });
})();
</script>
